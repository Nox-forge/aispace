<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Network Topology — Nox</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #0a0e14;
    color: #c5c8c6;
    font-family: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
    overflow: hidden;
  }
  #canvas { width: 100vw; height: 100vh; }
  svg { width: 100%; height: 100%; }

  .link { stroke-opacity: 0.35; }
  .link-label {
    font-size: 8px;
    fill: #444;
    text-anchor: middle;
    pointer-events: none;
  }

  .node-group { cursor: pointer; }
  .node-circle {
    stroke-width: 2;
    transition: filter 0.15s;
  }
  .node-group:hover .node-circle { filter: brightness(1.4) drop-shadow(0 0 6px currentColor); }
  .node-label {
    font-size: 10px;
    fill: #c5c8c6;
    text-anchor: middle;
    pointer-events: none;
    text-shadow: 0 0 3px #0a0e14, 0 0 6px #0a0e14, 0 0 9px #0a0e14;
  }
  .node-sublabel {
    font-size: 8px;
    fill: #555;
    text-anchor: middle;
    pointer-events: none;
  }

  .vlan-hull {
    fill-opacity: 0.03;
    stroke-opacity: 0.12;
    stroke-width: 1.5;
    stroke-dasharray: 5 3;
  }
  .vlan-label {
    font-size: 10px;
    fill-opacity: 0.25;
    text-anchor: middle;
    pointer-events: none;
  }

  #tooltip {
    position: absolute;
    background: #151920;
    border: 1px solid #2a2f38;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 12px;
    line-height: 1.6;
    max-width: 360px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.12s;
    z-index: 100;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6);
  }
  #tooltip.visible { opacity: 1; }
  #tooltip h3 { color: #e8e8e8; margin-bottom: 2px; font-size: 13px; }
  #tooltip .ip { color: #7aa2f7; font-size: 12px; }
  #tooltip .detail { color: #777; font-size: 11px; margin-top: 4px; }
  #tooltip .ports {
    color: #9ece6a; font-size: 10px; margin-top: 6px;
    padding-top: 6px; border-top: 1px solid #222;
  }

  #header {
    position: absolute;
    top: 18px;
    left: 22px;
    z-index: 10;
    pointer-events: none;
  }
  #header h1 {
    font-size: 15px;
    font-weight: 600;
    color: #7aa2f7;
    letter-spacing: 2px;
  }
  #header .sub {
    font-size: 10px;
    color: #444;
    margin-top: 3px;
  }

  #legend {
    position: absolute;
    bottom: 18px;
    left: 22px;
    z-index: 10;
    font-size: 10px;
    color: #555;
    pointer-events: none;
  }
  #legend .item {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 4px;
  }
  #legend .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  #stats {
    position: absolute;
    top: 18px;
    right: 22px;
    z-index: 10;
    font-size: 10px;
    color: #444;
    text-align: right;
    pointer-events: none;
  }
  #stats .val { color: #9ece6a; }
  #stats div { margin-bottom: 2px; }
</style>
</head>
<body>
<div id="header">
  <h1>KRZ NETWORK</h1>
  <div class="sub">Drag nodes / scroll to zoom / hover for details</div>
</div>

<div id="stats">
  <div>Devices <span class="val" id="stat-devices">0</span></div>
  <div>VLANs <span class="val" id="stat-vlans">0</span></div>
  <div>Services <span class="val" id="stat-services">0</span></div>
  <div style="margin-top:6px;color:#333">Built by Nox</div>
</div>

<div id="legend"></div>
<div id="tooltip"></div>
<div id="canvas"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// ── Color scheme ──────────────────────────────────────────
const VLAN_COLORS = {
  '53': '#7aa2f7',   // Main LAN
  '54': '#bb9af7',   // VLAN 54
  '55': '#e0af68',   // IoT/Media
  '56': '#9ece6a',   // Media VPN
  'infra': '#f7768e', // Infrastructure
};

const VLAN_NAMES = {
  '53': 'Main LAN (.53)',
  '54': 'VLAN 54',
  '55': 'IoT / Media (.55)',
  '56': 'Media VPN (.56)',
  'infra': 'Infrastructure',
};

// ── Network data ──────────────────────────────────────────
const nodes = [
  // Infrastructure
  { id: 'gateway', label: 'Cloud Gateway', sublabel: '.53.1', ip: '192.168.53.1', vlan: 'infra', r: 16,
    detail: 'UniFi Cloud Gateway Fiber\nAll VLAN routing', ports: 'SSH:22, HTTP:80, HTTPS:443, 8080, 8443' },
  { id: 'switch', label: 'USW Flex XG', sublabel: '.53.234', ip: '192.168.53.234', vlan: 'infra', r: 14,
    detail: '10G UniFi managed switch\n5+ ports active', ports: '' },
  { id: 'ap', label: 'U6 Lite', sublabel: '.53.113', ip: '192.168.53.113', vlan: 'infra', r: 12,
    detail: 'Ubiquiti WiFi 6 AP\nSSIDs: Cheerios, CheerioIOT', ports: '' },

  // VLAN 53 — Main LAN
  { id: 'clawdbot', label: 'Clawdbot (Nox)', sublabel: '.53.247', ip: '192.168.53.247', vlan: '53', r: 14,
    detail: 'Ubuntu 24.04 Hyper-V VM\nClaude Opus 4.5 home base', ports: 'WebDash:8088, Changedetect:5555' },
  { id: 'homeassistant', label: 'Home Assistant', sublabel: '.53.246', ip: '192.168.53.246', vlan: '53', r: 11,
    detail: 'Hyper-V VM\nSmart home automation', ports: 'HA:8123, Observer:4357' },
  { id: 'minecraft', label: 'Minecraft', sublabel: '.53.245', ip: '192.168.53.245', vlan: '53', r: 9,
    detail: 'Hyper-V VM\nAll ports filtered', ports: '' },
  { id: 'alex', label: 'Alex-PcLinux', sublabel: '.53.108', ip: '192.168.53.108', vlan: '53', r: 13,
    detail: 'NVIDIA RTX 3090 (24GB VRAM)\n64GB RAM · Ollama: 14 models\nGPU compute for AI inference', ports: 'Ollama:11434, Dockge:5001, Crypto:3000' },
  { id: 'nas', label: 'Synology NAS', sublabel: '.53.73', ip: '192.168.53.73', vlan: '53', r: 12,
    detail: 'Synology DS209\n10G connection', ports: 'SSH:22, SMB:445, DSM:5001, Drive:6690, NUT:3493' },
  { id: 'yvette', label: 'Yvette2 NAS', sublabel: '.53.240', ip: '192.168.53.240', vlan: '53', r: 11,
    detail: 'NETGEAR NAS\n10G connection', ports: 'HTTP:80, SMB:445, NFS:2049, rsync:873' },
  { id: 'desktop106', label: 'Desktop', sublabel: '.53.106', ip: '192.168.53.106', vlan: '53', r: 8,
    detail: 'Windows PC', ports: 'RPC:135, SMB:445' },
  { id: 'printer', label: 'Canon Printer', sublabel: '.53.58', ip: '192.168.53.58', vlan: '53', r: 8,
    detail: 'Canon printer/scanner', ports: 'HTTP:80, IPP:631, JetDirect:9100' },
  { id: 'xbox', label: 'Xbox', sublabel: '.53.124', ip: '192.168.53.124', vlan: '53', r: 6,
    detail: 'Xbox console\nAll ports filtered', ports: '' },
  { id: 'echo', label: 'Echo', sublabel: '.53.109', ip: '192.168.53.109', vlan: '53', r: 6,
    detail: 'Amazon Echo\nAll ports closed', ports: '' },
  { id: 'nintendo', label: 'Switch', sublabel: '.53.30', ip: '192.168.53.30', vlan: '53', r: 6,
    detail: 'Nintendo Switch\nAll ports filtered', ports: '' },
  { id: 'gt130', label: 'GT130', sublabel: '.53.125', ip: '192.168.53.125', vlan: '53', r: 5,
    detail: 'ESP32 IoT device\nBasic auth', ports: 'HTTP:80' },
  { id: 'iphone53', label: 'iPhone', sublabel: '.53.27', ip: '192.168.53.27', vlan: '53', r: 5,
    detail: 'iPhone · WiFi 6\nCheerios 5GHz', ports: '' },

  // VLAN 54
  { id: 'iphone54', label: 'iPhone', sublabel: '.54.82', ip: '192.168.54.82', vlan: '54', r: 5,
    detail: 'iPhone\nOffline/disconnected', ports: '' },

  // VLAN 55
  { id: 'tv', label: 'Samsung 98"', sublabel: '.55.44', ip: '192.168.55.44', vlan: '55', r: 11,
    detail: 'Samsung S550G 98" TV\nCheerioIOT WiFi 4', ports: 'AirPlay:7000, Cast:8008/8009, Netflix:9080' },
  { id: 'pc55', label: 'PC-STJ', sublabel: '.55.191', ip: '192.168.55.191', vlan: '55', r: 8,
    detail: 'Windows PC\nVLAN 55', ports: 'RPC:135, SMB:445' },

  // VLAN 56 — Media
  { id: 'plex', label: 'Plex Server', sublabel: '.56.231', ip: '192.168.56.231', vlan: '56', r: 13,
    detail: 'Windows · Plex + Audiobookshelf\nVPN: Internet VPN Canada\nAlso: .53.249 (LAN NIC)', ports: 'Plex:32400, Audiobookshelf:13378, RDP:3389, SMB:445' },
  { id: 'plexdl', label: 'PlexDownloader', sublabel: '.56.244', ip: '192.168.56.244', vlan: '56', r: 13,
    detail: 'Windows · Full *arr stack\nVPN: Internet VPN Canada', ports: 'Sonarr:8989, Radarr:7878, Readarr:8787, Prowlarr:9696, Jellyfin:8096, qBit:8080, Ombi:5000, Huntarr:9705' },
];

const links = [
  // Infrastructure backbone
  { source: 'gateway', target: 'switch', label: '10G', w: 3.5 },
  { source: 'gateway', target: 'ap', label: '', w: 2 },

  // Switch — wired connections
  { source: 'switch', target: 'clawdbot', label: '5G', w: 2.5 },
  { source: 'switch', target: 'homeassistant', label: '5G', w: 2 },
  { source: 'switch', target: 'minecraft', label: '5G', w: 1.5 },
  { source: 'switch', target: 'alex', label: 'GbE', w: 2 },
  { source: 'switch', target: 'nas', label: '10G', w: 3 },
  { source: 'switch', target: 'yvette', label: '10G', w: 3 },
  { source: 'switch', target: 'desktop106', w: 1 },
  { source: 'switch', target: 'printer', w: 1 },
  { source: 'switch', target: 'xbox', w: 0.8 },
  { source: 'switch', target: 'pc55', w: 1 },
  { source: 'switch', target: 'plex', label: 'GbE', w: 2.5 },
  { source: 'switch', target: 'plexdl', label: 'GbE', w: 2.5 },
  { source: 'gateway', target: 'gt130', w: 1 },

  // AP — wireless connections
  { source: 'ap', target: 'echo', w: 0.8 },
  { source: 'ap', target: 'nintendo', w: 0.8 },
  { source: 'ap', target: 'iphone53', label: 'WiFi 6', w: 1 },
  { source: 'ap', target: 'iphone54', w: 0.6 },
  { source: 'ap', target: 'tv', label: 'WiFi 4', w: 1 },

  // Special: API connection
  { source: 'clawdbot', target: 'alex', label: 'Ollama API', w: 1.5, dashed: true },
  // Hyper-V host relationship
  { source: 'plex', target: 'clawdbot', label: 'VM host', w: 1, dashed: true },
  { source: 'plex', target: 'homeassistant', label: 'VM', w: 0.8, dashed: true },
  { source: 'plex', target: 'minecraft', label: 'VM', w: 0.8, dashed: true },
];

// ── D3 visualization ─────────────────────────────────────
const width = window.innerWidth;
const height = window.innerHeight;

const svg = d3.select('#canvas')
  .append('svg')
  .attr('viewBox', [0, 0, width, height]);

const defs = svg.append('defs');

// Glow filter
const filter = defs.append('filter').attr('id', 'glow');
filter.append('feGaussianBlur').attr('stdDeviation', '3').attr('result', 'blur');
const feMerge = filter.append('feMerge');
feMerge.append('feMergeNode').attr('in', 'blur');
feMerge.append('feMergeNode').attr('in', 'SourceGraphic');

const g = svg.append('g');

// Zoom
const zoomBehavior = d3.zoom()
  .scaleExtent([0.2, 5])
  .on('zoom', (event) => g.attr('transform', event.transform));
svg.call(zoomBehavior);
svg.call(zoomBehavior.transform, d3.zoomIdentity.translate(width * 0.05, height * 0.05).scale(0.9));

// Layers
const hullG = g.append('g').attr('class', 'hulls');
const linkG = g.append('g').attr('class', 'links');
const nodeG = g.append('g').attr('class', 'nodes');

// VLAN groups for hulls
const vlanGroups = {};
nodes.forEach(n => {
  if (!vlanGroups[n.vlan]) vlanGroups[n.vlan] = [];
  vlanGroups[n.vlan].push(n);
});

// Links
const linkSel = linkG.selectAll('.link')
  .data(links)
  .join('line')
  .attr('class', 'link')
  .attr('stroke', d => {
    const src = nodes.find(n => n.id === (typeof d.source === 'string' ? d.source : d.source.id));
    return src ? (VLAN_COLORS[src.vlan] || '#333') : '#333';
  })
  .attr('stroke-width', d => d.w || 1)
  .attr('stroke-dasharray', d => d.dashed ? '5 3' : null);

const linkLabelSel = linkG.selectAll('.link-label')
  .data(links.filter(d => d.label))
  .join('text')
  .attr('class', 'link-label')
  .text(d => d.label);

// Nodes
const nodeSel = nodeG.selectAll('.node-group')
  .data(nodes)
  .join('g')
  .attr('class', 'node-group')
  .call(d3.drag()
    .on('start', (event, d) => {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x; d.fy = d.y;
    })
    .on('drag', (event, d) => { d.fx = event.x; d.fy = event.y; })
    .on('end', (event, d) => {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null; d.fy = null;
    }));

// Node circles with glow
nodeSel.append('circle')
  .attr('class', 'node-circle')
  .attr('r', d => d.r)
  .attr('fill', d => {
    const c = VLAN_COLORS[d.vlan] || '#555';
    return d.id === 'clawdbot' ? c : c + 'aa';
  })
  .attr('stroke', d => {
    const c = d3.color(VLAN_COLORS[d.vlan] || '#555');
    return c ? c.brighter(0.6) : '#777';
  })
  .attr('filter', d => d.id === 'clawdbot' ? 'url(#glow)' : null);

// Pulse ring for Clawdbot
const pulseNode = nodeSel.filter(d => d.id === 'clawdbot');
pulseNode.insert('circle', '.node-circle')
  .attr('class', 'pulse-ring')
  .attr('r', 18)
  .attr('fill', 'none')
  .attr('stroke', VLAN_COLORS['53'])
  .attr('stroke-opacity', 0.4)
  .attr('stroke-width', 1.5);

// Labels
nodeSel.append('text')
  .attr('class', 'node-label')
  .attr('dy', d => -d.r - 5)
  .text(d => d.label);

nodeSel.append('text')
  .attr('class', 'node-sublabel')
  .attr('dy', d => d.r + 12)
  .text(d => d.sublabel);

// Tooltip
const tooltip = d3.select('#tooltip');
nodeSel
  .on('mouseover', (event, d) => {
    let html = `<h3>${d.label}</h3>`;
    html += `<div class="ip">${d.ip}</div>`;
    if (d.detail) html += `<div class="detail">${d.detail.replace(/\n/g, '<br>')}</div>`;
    if (d.ports) html += `<div class="ports">${d.ports}</div>`;
    tooltip.html(html).classed('visible', true);
  })
  .on('mousemove', (event) => {
    tooltip.style('left', (event.pageX + 16) + 'px').style('top', (event.pageY - 12) + 'px');
  })
  .on('mouseout', () => tooltip.classed('visible', false));

// Force simulation
const simulation = d3.forceSimulation(nodes)
  .force('link', d3.forceLink(links).id(d => d.id).distance(d => {
    if (d.dashed) return 160;
    const sr = (typeof d.source === 'object' ? d.source.r : 10);
    const tr = (typeof d.target === 'object' ? d.target.r : 10);
    return 60 + sr + tr + (d.w || 1) * 10;
  }).strength(d => d.dashed ? 0.15 : 0.4))
  .force('charge', d3.forceManyBody().strength(-350))
  .force('center', d3.forceCenter(width / 2, height / 2))
  .force('collision', d3.forceCollide().radius(d => d.r + 20))
  .force('x', d3.forceX(width / 2).strength(0.02))
  .force('y', d3.forceY(height / 2).strength(0.02))
  .on('tick', ticked);

function ticked() {
  linkSel
    .attr('x1', d => d.source.x).attr('y1', d => d.source.y)
    .attr('x2', d => d.target.x).attr('y2', d => d.target.y);

  linkLabelSel
    .attr('x', d => (d.source.x + d.target.x) / 2)
    .attr('y', d => (d.source.y + d.target.y) / 2 - 5);

  nodeSel.attr('transform', d => `translate(${d.x},${d.y})`);

  // VLAN convex hulls
  hullG.selectAll('*').remove();
  Object.entries(vlanGroups).forEach(([vlan, members]) => {
    if (members.length < 3) return;
    const pts = members.map(m => [m.x, m.y]);
    const hull = d3.polygonHull(pts);
    if (!hull) return;

    const cx = d3.mean(hull, p => p[0]);
    const cy = d3.mean(hull, p => p[1]);
    const expanded = hull.map(p => {
      const dx = p[0] - cx, dy = p[1] - cy;
      const dist = Math.sqrt(dx * dx + dy * dy);
      const scale = (dist + 50) / dist;
      return [cx + dx * scale, cy + dy * scale];
    });

    hullG.append('path')
      .attr('class', 'vlan-hull')
      .attr('d', 'M' + expanded.join('L') + 'Z')
      .attr('fill', VLAN_COLORS[vlan] || '#333')
      .attr('stroke', VLAN_COLORS[vlan] || '#333');

    hullG.append('text')
      .attr('class', 'vlan-label')
      .attr('x', cx)
      .attr('y', d3.min(expanded, p => p[1]) - 6)
      .attr('fill', VLAN_COLORS[vlan] || '#333')
      .text(VLAN_NAMES[vlan] || vlan);
  });
}

// Pulse animation
(function animatePulse() {
  d3.selectAll('.pulse-ring')
    .transition().duration(1800).ease(d3.easeQuadOut)
    .attr('r', 26).attr('stroke-opacity', 0)
    .transition().duration(0)
    .attr('r', 18).attr('stroke-opacity', 0.4)
    .on('end', animatePulse);
})();

// Stats
const totalServices = nodes.reduce((s, n) => s + (n.ports ? n.ports.split(',').filter(x => x.trim()).length : 0), 0);
document.getElementById('stat-devices').textContent = nodes.length;
document.getElementById('stat-vlans').textContent = Object.keys(vlanGroups).length;
document.getElementById('stat-services').textContent = totalServices;

// Legend
const legendDiv = document.getElementById('legend');
[['infra', 'Infrastructure'], ['53', 'Main LAN (.53)'], ['55', 'IoT / Media (.55)'], ['56', 'Media VPN (.56)'], ['54', 'VLAN 54']].forEach(([vlan, name]) => {
  const item = document.createElement('div');
  item.className = 'item';
  item.innerHTML = `<div class="dot" style="background:${VLAN_COLORS[vlan]}"></div>${name}`;
  legendDiv.appendChild(item);
});
</script>
</body>
</html>
